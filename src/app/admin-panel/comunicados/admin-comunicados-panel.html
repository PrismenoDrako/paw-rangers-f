<div class="com-admin">
  <header class="admin-head">
    <div>
      <p class="eyebrow">PawComunicados</p>
      <h1>Editor de comunicados</h1>
      <p class="subtitle">Crea avisos oficiales para eventos, servicio, producto y ayuda social.</p>
    </div>
  </header>

  <form [formGroup]="form" (ngSubmit)="save()" class="admin-form">
    <div class="form-row">
      <label>Título</label>
      <input type="text" formControlName="message" placeholder="Ej. Jornada de adopción este sábado" />
    </div>
    <div class="form-row">
      <label>Resumen</label>
      <textarea rows="3" formControlName="context" placeholder="Breve descripción del comunicado"></textarea>
    </div>
    <div class="form-grid">
      <div class="form-row">
        <label>Publicado por</label>
        <input type="text" formControlName="publisher" placeholder="PawRangers" />
        <p class="hint">Puedes editar el nombre del emisor (empresa, aliado o usuario).</p>
      </div>
      <div class="form-row">
        <label>Categoría</label>
        <select formControlName="category">
          <option *ngFor="let cat of categorias" [value]="cat.value">{{ cat.label }}</option>
        </select>
      </div>
      <div class="form-row">
        <label>Badge</label>
        <select formControlName="badge">
          <option *ngFor="let b of badges" [value]="b.value">{{ b.label }}</option>
        </select>
      </div>
      <div class="form-row">
        <label>Fecha publicación</label>
        <input type="datetime-local" formControlName="date" [min]="minDate" />
      </div>
    </div>
    <div class="form-grid">
      <div class="form-row upload-row">
        <label>Imagen</label>
        <div class="upload-area" [class.has-image]="previewUrl">
          <input type="file" accept="image/*" (change)="handleImage($event)" />
          <div class="upload-copy">
            <p class="upload-title">Sube una imagen</p>
            <p class="hint">Recomendado 16:9 · Máx 5MB</p>
          </div>
          <div class="preview" *ngIf="previewUrl">
            <img [src]="previewUrl" alt="Vista previa" />
            <button type="button" class="ghost" (click)="clearImage()">Quitar imagen</button>
          </div>
        </div>
      </div>
      <div class="form-row">
        <label>Enlace externo (https://) <span class="hint-inline">opcional</span></label>
        <input type="text" formControlName="targetUrl" placeholder="https://tusitio.com/evento" />
        <p class="hint">Debe ser un link http(s) válido; si lo dejas vacío no se mostrará botón.</p>
      </div>
      <div class="form-row upload-row avatar-row">
        <label>Icono / avatar (opcional)</label>
        <div class="avatar-upload">
          <input type="file" accept="image/*" (change)="handleAvatar($event)" />
          <div class="avatar-preview" [class.has-avatar]="avatarUrl">
            <ng-container *ngIf="avatarUrl; else avatarEmpty">
              <img [src]="avatarUrl" alt="Avatar" />
            </ng-container>
            <ng-template #avatarEmpty>
              <span class="avatar-fallback">PR</span>
            </ng-template>
          </div>
          <button type="button" class="ghost mini" (click)="clearAvatar()" *ngIf="avatarUrl">Quitar</button>
        </div>
        <p class="hint">Si subes un icono, será la cabecera del comunicado; puedes dejarlo vacío.</p>
      </div>
    </div>

    <div class="actions">
      <button type="button" class="ghost" (click)="openPreview()">Vista previa</button>
      <button type="submit" class="primary">{{ editingId ? 'Actualizar comunicado' : 'Publicar comunicado' }}</button>
    </div>
  </form>

  <div class="preview-modal" *ngIf="showPreview && previewItem">
    <div class="preview-overlay-card">
      <button type="button" class="close-btn" (click)="closePreview()">×</button>
      <div class="preview-hero" *ngIf="previewItem.image">
        <img [src]="previewItem.image" alt="Imagen del comunicado" />
      </div>
      <div class="preview-content">
        <div class="preview-user">
          <div class="avatar" [class.has-img]="avatarUrl">
            <img *ngIf="avatarUrl" [src]="avatarUrl" alt="Avatar" />
            <span *ngIf="!avatarUrl">PR</span>
          </div>
          <div>
            <p class="user-name">{{ previewItem.payload?.['publisherName'] || 'PawRangers' }}</p>
            <p class="user-role">Comunicado</p>
          </div>
        </div>
        <div class="preview-meta">
          <span class="badge">{{ previewItem.category | titlecase }}</span>
          <span class="time">{{ previewItem.timestamp }}</span>
        </div>
        <h2 class="preview-title">{{ previewItem.message }}</h2>
        <p class="muted">{{ previewItem.context }}</p>
        <div class="cta-row" *ngIf="previewItem.targetUrl">
          <a class="primary-link" [href]="previewItem.targetUrl" target="_blank" rel="noopener">Abrir enlace externo</a>
        </div>
      </div>
    </div>
  </div>

  <section class="list">
    <h2>Comunicados publicados</h2>
    <div class="card" *ngFor="let item of comunicados">
      <div>
        <p class="eyebrow">{{ item.category | titlecase }}</p>
        <h3>{{ item.message }}</h3>
        <p class="muted">{{ item.context }}</p>
        <p class="muted small">
          Publicado: {{ item.createdAt | date : 'd MMM y, HH:mm' }}
          <ng-container *ngIf="getUpdatedAt(item.payload) as updated">
            · Editado: {{ updated | date : 'd MMM y, HH:mm' }}
          </ng-container>
        </p>
      </div>
      <div class="card-actions">
        <button type="button" class="ghost" (click)="startEdit(item)">Editar</button>
        <button type="button" class="ghost danger" (click)="delete(item.id)">Eliminar</button>
      </div>
    </div>
  </section>
</div>
