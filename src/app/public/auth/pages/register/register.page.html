<app-auth-layout title="Crea tu cuenta" illustrationSrc="assets/img/fondoregistrar.png">
  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="auth-form">
    <p class="error" *ngIf="error">{{ error }}</p>

    <div class="field">
      <label for="name">Nombre</label>
      <div class="input-wrapper">
        <i class="pi pi-user"></i>
        <input id="name" type="text" formControlName="name" placeholder="Tu nombre" autocomplete="given-name" />
      </div>
      <small class="p-error" *ngIf="form.controls.name.touched && form.controls.name.invalid">
        Ingresa tu nombre.
      </small>
    </div>

    <div class="field">
      <label for="lastName1">Apellido Paterno</label>
      <div class="input-wrapper">
        <i class="pi pi-id-card"></i>
        <input id="lastName1" type="text" formControlName="lastName1" placeholder="Tu apellido paterno" autocomplete="family-name" />
      </div>
      <small class="p-error" *ngIf="form.controls.lastName1.touched && form.controls.lastName1.invalid">
        Ingresa tu apellido paterno.
      </small>
    </div>

    <div class="field">
      <label for="lastName2">Apellido Materno</label>
      <div class="input-wrapper">
        <i class="pi pi-id-card"></i>
        <input id="lastName2" type="text" formControlName="lastName2" placeholder="Tu apellido materno (opcional)" autocomplete="family-name" />
      </div>
    </div>

    <div class="field">
      <label for="username">Nombre de Usuario</label>
      <div class="input-wrapper">
        <i class="pi pi-user-edit"></i>
        <input id="username" type="text" formControlName="username" placeholder="Tu nombre de usuario" autocomplete="username" />
      </div>
      <small class="p-error" *ngIf="form.controls.username.touched && form.controls.username.invalid">
        Ingresa un nombre de usuario (mínimo 3 caracteres).
      </small>
    </div>

    <div class="field">
      <label for="email">Correo</label>
      <div class="input-wrapper">
        <i class="pi pi-envelope"></i>
        <input id="email" type="email" formControlName="email" placeholder="tu@correo.com" autocomplete="email" />
      </div>
      <small class="p-error" *ngIf="form.controls.email.touched && form.controls.email.invalid">
        Ingresa un correo válido.
      </small>
    </div>

    <div class="field">
      <label for="docType">Tipo de Documento</label>
      <div class="input-wrapper">
        <i class="pi pi-id-card"></i>
        <select
          id="docType"
          formControlName="docType"
          class="doc-type-select"
          (change)="onDocTypeChange($event)"
        >
          <option [value]="''">Selecciona tu tipo de documento</option>
          <option *ngFor="let docType of docTypes" [value]="docType.id">
            {{ docType.name }} ({{ docType.length }} dígitos)
          </option>
        </select>
      </div>
      <small class="p-error" *ngIf="form.controls.docType.touched && form.controls.docType.invalid">
        Selecciona un tipo de documento.
      </small>
    </div>

    <div class="field">
      <label for="docNumber">
        Número de Documento
        <span *ngIf="selectedDocTypeLength > 0" class="doc-length-hint">({{ selectedDocTypeLength }} dígitos)</span>
      </label>
      <div class="input-wrapper">
        <i class="pi pi-credit"></i>
        <input
          id="docNumber"
          type="text"
          formControlName="docNumber"
          placeholder="Ingresa tu número de documento"
          [maxlength]="selectedDocTypeLength || 12"
          [disabled]="!form.controls.docType.value"
          (input)="onDocNumberInput($event)"
          inputmode="numeric"
        />
      </div>
      <small class="p-error" *ngIf="form.controls.docNumber.touched && form.controls.docNumber.invalid">
        <span *ngIf="form.controls.docNumber.errors?.['required']">Número de documento requerido.</span>
        <span *ngIf="form.controls.docNumber.errors?.['minlength'] || form.controls.docNumber.errors?.['maxlength']">
          Debe tener exactamente {{ selectedDocTypeLength }} dígitos.
        </span>
        <span *ngIf="form.controls.docNumber.errors?.['notNumeric']">Solo se permiten números.</span>
      </small>
    </div>

    <div class="field">
      <label for="password">Contraseña</label>
      <div class="input-wrapper">
        <i class="pi pi-lock"></i>
        <input
          id="password"
          [type]="showPassword ? 'text' : 'password'"
          formControlName="password"
          placeholder="********"
          autocomplete="new-password"
        />
        <button type="button" class="toggle-visibility" (click)="togglePassword()" aria-label="Mostrar u ocultar contraseña">
          <i class="pi" [ngClass]="showPassword ? 'pi-eye-slash' : 'pi-eye'"></i>
        </button>
      </div>
      <small class="p-error" *ngIf="form.controls.password.touched && form.controls.password.invalid">
        Mínimo 6 caracteres, 1 mayúscula, 1 minúscula, 1 número y 1 símbolo.
      </small>
    </div>

    <div class="field">
      <label for="confirmPassword">Confirmar contraseña</label>
      <div class="input-wrapper">
        <i class="pi pi-shield"></i>
        <input
          id="confirmPassword"
          [type]="showConfirm ? 'text' : 'password'"
          formControlName="confirmPassword"
          placeholder="Repite tu contraseña"
          autocomplete="new-password"
        />
        <button
          type="button"
          class="toggle-visibility"
          (click)="toggleConfirm()"
          aria-label="Mostrar u ocultar confirmación"
        >
          <i class="pi" [ngClass]="showConfirm ? 'pi-eye-slash' : 'pi-eye'"></i>
        </button>
      </div>
      <small
        class="p-error"
        *ngIf="form.controls.confirmPassword.touched && form.value.password !== form.value.confirmPassword"
      >
        Las contraseñas deben coincidir.
      </small>
    </div>

    <label class="checkbox">
      <input type="checkbox" formControlName="acceptTerms" />
      <span>
        Acepto los
        <button type="button" class="link-inline" (click)="openTerms($event)">Términos y la Política de Privacidad</button>
      </span>
    </label>

    <div class="actions">
      <button class="primary-btn" type="submit" [disabled]="loading || form.invalid">
        {{ loading ? 'Creando...' : 'Crear cuenta' }}
      </button>
      <a routerLink="/auth" class="secondary-link">Ya tengo cuenta</a>
    </div>
  </form>

  <div class="modal-backdrop" *ngIf="showTerms" (click)="closeTerms()"></div>
  <div class="modal" *ngIf="showTerms">
    <header class="modal__header">
      <h2>Términos y Condiciones</h2>
      <button type="button" class="modal__close" aria-label="Cerrar" (click)="closeTerms()">×</button>
    </header>
    <section class="modal__body">
      <p>
        Estos términos rigen el uso de PawRangers. Al crear tu cuenta aceptas usarlos de forma lícita. Si no estás de
        acuerdo, no utilices la app.
      </p>
      <h3>1. Registro y cuenta</h3>
      <ul>
        <li>Proporciona datos veraces y mantén segura tu contraseña.</li>
        <li>Eres responsable de toda actividad con tus credenciales.</li>
      </ul>
      <h3>2. Uso de la app</h3>
      <ul>
        <li>Publica información precisa sobre mascotas perdidas/encontradas.</li>
        <li>No publiques contenido ilegal, ofensivo o comercial sin permiso.</li>
        <li>No intentes vulnerar la seguridad ni extraer datos sin autorización.</li>
      </ul>
      <h3>3. Contenido de usuarios</h3>
      <p>Las fotos y descripciones que subas pueden usarse para operar y mejorar el servicio, sin garantía de resultado.</p>
      <h3>4. Propiedad intelectual</h3>
      <p>La app y su contenido son de PawRangers o sus licenciantes. No lo reproduzcas ni distribuyas sin autorización.</p>
      <h3>5. Privacidad</h3>
      <ul>
        <li>Datos: nombre, correo, ubicación opcional y datos técnicos.</li>
        <li>Usos: crear cuenta, autenticación, notificaciones de mascotas, seguridad y mejora.</li>
        <li>Compartimos solo con proveedores necesarios y bajo confidencialidad.</li>
        <li>Derechos: acceso, rectificación, eliminación. Escríbenos a soporte@pawrangers.com.</li>
      </ul>
      <h3>6. Responsabilidad</h3>
      <p>El servicio se ofrece “tal cual”. No garantizamos disponibilidad ni resultados y se limitan responsabilidades según ley.</p>
      <h3>7. Cambios y ley aplicable</h3>
      <p>Podemos actualizar estos términos; se aplican desde su publicación. Se rigen por la ley local y tribunales competentes.</p>
      <p class="modal__note">Última actualización: 09/12/2025.</p>
    </section>
    <footer class="modal__footer">
      <button type="button" class="primary-btn" (click)="closeTerms()">Entendido</button>
    </footer>
  </div>
</app-auth-layout>
